# üõ°Ô∏è –°–ò–°–¢–ï–ú–ê –ó–ê–©–ò–¢–´ –°–û–û–ë–©–ï–ù–ò–ô –û–¢ –ü–û–¢–ï–†–ò

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- –°–æ–æ–±—â–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—Å—å –¢–û–õ–¨–ö–û –≤ –ø–∞–º—è—Ç–∏ (`const messages = {}`)
- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ PM2 –≤—Å–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —É–¥–∞–ª—è–ª–∏—Å—å
- WebSocket —Å–æ–æ–±—â–µ–Ω–∏—è –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –Ω–∞ –¥–∏—Å–∫
- –ù–µ –±—ã–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–∞–ø–∞

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (Triple-Layer Protection)

### üîí –£—Ä–æ–≤–µ–Ω—å 1: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–π—Å—Ç–≤–∏–∏
**–ö–æ–≥–¥–∞:** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ POST –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ WebSocket —Å–æ–±—ã—Ç–∏—è

**–ì–¥–µ:**
- `POST /api/channels/:channelId/messages` ‚Üí `saveMessages()`
- `socket.on('newMessage')` ‚Üí `saveMessages()` üÜï
- `POST /api/dm/:userId/messages` ‚Üí `saveDMMessages()`
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí `saveMessages()`
- –õ–∞–π–∫ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Üí `saveMessages()`

**–ö–æ–¥:**
```javascript
socket.on('newMessage', (data) => {
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  messages[channelId].push(message);
  
  // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°–û–•–†–ê–ù–Ø–ï–ú –ù–ê –î–ò–°–ö –°–†–ê–ó–£!
  saveMessages();
  
  io.emit('newMessage', { channelId, message });
});
```

### üîí –£—Ä–æ–≤–µ–Ω—å 2: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
**–ö–æ–≥–¥–∞:** –¢–∞–π–º–µ—Ä –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

**–ó–∞—á–µ–º:** –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∑–∞–±—ã–ª–∏ –≤—ã–∑–≤–∞—Ç—å `saveMessages()` –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ

**–ö–æ–¥:**
```javascript
setInterval(() => {
  console.log('‚è∞ Auto-saving messages (every 5 minutes)...');
  saveMessages();
  saveDMMessages();
  saveUsers();
}, 5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç
```

**–õ–æ–≥ –≤ PM2:**
```
‚è∞ Auto-saving messages (every 5 minutes)...
üíæ Messages saved to disk
üíæ BACKUP created: messages_2025-12-17T10-15-00-000Z.json
```

### üîí –£—Ä–æ–≤–µ–Ω—å 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞
**–ö–æ–≥–¥–∞:** PM2 restart, kill, SIGINT, SIGTERM

**–ó–∞—á–µ–º:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

**–ö–æ–¥:**
```javascript
process.on('SIGINT', () => {
  console.log('üõë Server shutting down...');
  console.log('üíæ Saving all data before exit...');
  
  saveMessages();
  saveDMMessages();
  saveUsers();
  saveRules();
  
  console.log('‚úÖ All data saved. Goodbye!');
  process.exit(0);
});

process.on('SIGTERM', () => {
  // –¢–æ –∂–µ —Å–∞–º–æ–µ
});
```

## üì¶ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Backup

**–ü—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:**
1. –°–æ–∑–¥–∞–µ—Ç—Å—è –±—ç–∫–∞–ø —Å—Ç–∞—Ä–æ–≥–æ —Ñ–∞–π–ª–∞: `messages_2025-12-17T10-00-00-000Z.json`
2. –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 –±—ç–∫–∞–ø–æ–≤
3. –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è

**–ö–æ–¥:**
```javascript
function createBackup(filePath, dataName) {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const backupFileName = `${dataName}_${timestamp}.json`;
  const backupPath = path.join(BACKUP_DIR, backupFileName);
  
  fs.copyFileSync(filePath, backupPath);
  console.log(`üíæ BACKUP created: ${backupFileName}`);
  
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ (—Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ 50)
  const backupFiles = fs.readdirSync(BACKUP_DIR)
    .filter(f => f.startsWith(dataName))
    .sort()
    .reverse();
  
  if (backupFiles.length > 50) {
    const toDelete = backupFiles.slice(50);
    toDelete.forEach(f => fs.unlinkSync(path.join(BACKUP_DIR, f)));
  }
}
```

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
```bash
ssh root@5.249.160.54 "wc -l /root/lonestar-chat/backend/database/messages.json"
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** > 100 —Å—Ç—Ä–æ–∫ (–Ω–µ 3 –±–∞–π—Ç–∞!)

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:
```bash
ssh root@5.249.160.54 "pm2 logs lonestar-chat --lines 100 | grep 'Auto-saving'"
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±—ç–∫–∞–ø—ã:
```bash
ssh root@5.249.160.54 "ls -lh /root/lonestar-chat/backend/backups/ | grep messages | tail -10"
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –°–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤ —Å –¥–∞—Ç–∞–º–∏

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WebSocket —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:
```bash
ssh root@5.249.160.54 "pm2 logs lonestar-chat --lines 100 | grep 'WebSocket message saved'"
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è WebSocket —Å–æ–æ–±—â–µ–Ω–∏–π

## üéØ –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
/root/lonestar-chat/backend/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ messages.json          ‚Üê –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª (193 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îú‚îÄ‚îÄ dm_messages.json       ‚Üê –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ users.json             ‚Üê 68 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ app_rules.json         ‚Üê –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îî‚îÄ‚îÄ backups/
    ‚îú‚îÄ‚îÄ messages_2025-12-17T05-09-18-255Z.json
    ‚îú‚îÄ‚îÄ messages_2025-12-17T10-00-00-000Z.json
    ‚îú‚îÄ‚îÄ ... (–¥–æ 50 —Ñ–∞–π–ª–æ–≤)
    ‚îî‚îÄ‚îÄ users_2025-12-17T10-00-00-000Z.json
```

## üö® –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–ø–∞–ª–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª:
```bash
ssh root@5.249.160.54 "cat /root/lonestar-chat/backend/database/messages.json | head -50"
```

### 2. –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø:
```bash
ssh root@5.249.160.54 "ls -lt /root/lonestar-chat/backend/backups/messages_* | head -5"
```

### 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞:
```bash
ssh root@5.249.160.54 "cp /root/lonestar-chat/backend/backups/messages_TIMESTAMP.json /root/lonestar-chat/backend/database/messages.json"
ssh root@5.249.160.54 "pm2 restart lonestar-chat"
```

## ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–∏

1. **–ü—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏**: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫ –°–†–ê–ó–£
2. **–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø
3. **–ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ–º
4. **50 –±—ç–∫–∞–ø–æ–≤**: –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª—é–±–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ù–ï –ü–†–û–ü–ê–î–£–¢ –¥–∞–∂–µ –ø—Ä–∏:**
- ‚ùå –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ PM2
- ‚ùå –°–±–æ–µ —Å–µ—Ä–≤–µ—Ä–∞
- ‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∏–∏ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞ (–µ—Å–ª–∏ —É—Å–ø–µ–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å)
- ‚ùå –û—à–∏–±–∫–µ –≤ –∫–æ–¥–µ

## üìÖ –°–æ–∑–¥–∞–Ω–æ: December 17, 2025
## üìù –û–±–Ω–æ–≤–ª–µ–Ω–æ: December 17, 2025
## ‚úÖ –°—Ç–∞—Ç—É—Å: **–ê–ö–¢–ò–í–ù–û –ò –†–ê–ë–û–¢–ê–ï–¢**
